blueprint:
  name: Lock Door (Parallel + Look Ahead + Trim Fix)
  description: >
    Locks the door after an event ends.
    Features:
    1. PARALLEL mode (won't miss overlapping events).
    2. LOOK AHEAD (won't lock if next meeting starts soon).
    3. TRIM FIX (ignores accidental spaces in your keyword).
  domain: automation
  input:
    calendar_entity:
      name: Calendar Entity
      description: The calendar to monitor.
      selector:
        entity:
          domain: calendar
    lock_offset:
      name: Lock Offset
      description: >
        How long to wait after the event ends before ATTEMPTING to lock.
        (Recommended: 5 minutes)
      default: "0:05:0"
      selector:
        duration: {}
    pre_event_buffer:
      name: Look Ahead Buffer
      description: >
        Do not lock if the NEXT event starts within this time frame.
        (Recommended: 20 minutes)
      default: "0:20:0"
      selector:
        duration: {}
    input_text_keyword:
      name: Keyword Input Text
      description: >
        Entity containing the keyword (e.g., "*").
        The automation automatically removes accidental spaces from this input.
        If empty, runs for every event.
      selector:
        entity:
          domain: input_text
    door_lock_entity:
      name: Door Lock Check
      description: The door lock to check (automation only runs if this is currently unlocked).
      selector:
        entity:
          domain: lock
    door_lock_rule_select:
      name: Door Lock Rule Select Entity
      description: The select entity that triggers your locking logic (sets to 'reset').
      selector:
        entity:
          domain: select
    notify_device:
      name: Notification Device
      description: Select the mobile device to send notifications to.
      selector:
        device:
          integration: mobile_app

# ----------------------------------------------------------------------
# VARIABLES
# ----------------------------------------------------------------------
variables:
  calendar: !input calendar_entity
  keyword_entity_id: !input input_text_keyword
  buffer_input: !input pre_event_buffer

trigger:
  - platform: calendar
    event: end
    entity_id: !input calendar_entity
    offset: !input lock_offset

condition:
  # 1. Check if door is unlocked
  - condition: state
    entity_id: !input door_lock_entity
    state: "unlocked"

  # 2. Check for IMMEDIATE Overlaps (Calendar must be 'off')
  - condition: state
    entity_id: !input calendar_entity
    state: "off"

  # 3. The "Look Ahead" Check
  - condition: template
    value_template: >
      {% set next_start_str = state_attr(calendar, 'start_time') %}
      {% if next_start_str == None %}
        true
      {% else %}
        {% set next_start = as_datetime(next_start_str) %}
        {% set buffer_delta = buffer_input | as_timedelta %}
        {{ (next_start - now()) > buffer_delta }}
      {% endif %}

  # 4. Keyword Check (With TRIM Fix)
  - condition: template
    value_template: >
      {# Retrieve the keyword and strip invisible spaces #}
      {% set keyword = states(keyword_entity_id) | trim %}
      
      {% set title = trigger.calendar_event.summary | default('') %}
      {% set desc = trigger.calendar_event.description | default('') %}
      
      {# Check: If keyword is empty, OR if keyword is found in title/desc #}
      {{ keyword == '' or keyword in title or keyword in desc }}

action:
  - service: select.select_option
    target:
      entity_id: !input door_lock_rule_select
    data:
      option: "reset"
  
  - domain: mobile_app
    type: notify
    device_id: !input notify_device
    title: "Doors Locked"
    message: "The event '{{ trigger.calendar_event.summary }}' has finished and the doors have locked."

mode: parallel
max: 10
