blueprint:
  name: "Safety: Periodic Sweep (Advanced Overlap Check)"
  description: >
    The "Janitor" for your locks. Runs every 15 minutes.
    
    SMART LOGIC:
    1. It fetches a LIST of all active events right now (handling overlaps).
    2. It checks each event.
    3. If it finds AT LEAST ONE valid event (not canceled), it does nothing (Door stays open).
    4. If it finds ZERO valid events (Calendar is empty, or all active events are "Canceled"), it LOCKS the door.
  domain: automation
  input:
    calendar_entity:
      name: Calendar Entity
      selector:
        entity:
          domain: calendar
    door_lock_entity:
      name: Door Lock Entity
      selector:
        entity:
          domain: lock
    door_lock_rule_select:
      name: Door Lock Rule Select Entity
      description: The select entity that triggers your locking logic (sets to 'reset').
      selector:
        entity:
          domain: select
    notify_device:
      name: Notification Device
      selector:
        device:
          integration: mobile_app

trigger:
  - platform: time_pattern
    minutes: "/15"  # Runs at :00, :15, :30, :45

condition:
  # Only run if door is UNLOCKED (Save resources)
  - condition: state
    entity_id: !input door_lock_entity
    state: "unlocked"

action:
  # STEP 1: Perform a "Deep Scan" of the calendar
  - service: calendar.get_events
    target:
      entity_id: !input calendar_entity
    data:
      # Look at the next 1 minute to catch whatever is active right now
      start_date_time: "{{ now() }}"
      duration:
        minutes: 1
    response_variable: scheduled_events

  # STEP 2: Analyze the list
  - choose:
      # LOCK CONDITION:
      # We check the list. If we cannot find ANY event that is "valid" (not canceled), we Lock.
      - conditions:
          - condition: template
            value_template: >
              {% set events = scheduled_events[user_inputs['calendar_entity']]['events'] %}
              
              {# Initialize a "valid_meeting_found" flag to False #}
              {% set ns = namespace(found=false) %}

              {# Loop through every event found in the scan #}
              {% for event in events %}
                {# Check if event is actually active RIGHT NOW #}
                {% set start = as_datetime(event.start) %}
                {% set end = as_datetime(event.end) %}
                {% if start <= now() < end %}
                  
                  {# Check for Cancellation Keywords #}
                  {% set title = event.summary | lower %}
                  {% set desc = event.description | lower | default('') %}
                  
                  {% if 'canceled' not in title and 'cancelled' not in title %}
                     {# We found a REAL meeting! Set flag to True #}
                     {% set ns.found = true %}
                  {% endif %}
                  
                {% endif %}
              {% endfor %}

              {# The Condition passes (LOCK THE DOOR) only if found is still FALSE #}
              {{ ns.found == false }}
        sequence:
          - service: select.select_option
            target:
              entity_id: !input door_lock_rule_select
            data:
              option: "reset"
          - domain: mobile_app
            type: notify
            device_id: !input notify_device
            title: "Security Sweeper"
            message: "No valid active events found (Calendar empty or all canceled). Door locked."
            
  # Note: If ns.found is True (a valid meeting exists), the Choose block skips, and the door stays unlocked.
