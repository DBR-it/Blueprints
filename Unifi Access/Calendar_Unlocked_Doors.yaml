blueprint:
  name: Unlock Door Before Event with Input Text Keyword and Notification Device
  description: >
    Unlocks a door a specified duration before an event starts if the event's title
    contains the keyword stored in the selected input_text entity.
    The automation only runs if the door is currently locked.
  domain: automation
  input:
    calendar_entity:
      name: Calendar Entity
      description: Select the calendar to monitor for events.
      selector:
        entity:
          domain: calendar
    input_text_keyword:
      name: Door Keyword Input Text
      description: Select the input_text entity that stores the door keyword.
      selector:
        entity:
          domain: input_text
    unlock_offset:
      name: Unlock Offset
      description: The duration before an event's start when the door should be unlocked.
      default: "-00:30:00"
      selector:
        duration: {}
    door_lock_entity:
      name: Door Lock Entity
      description: The door lock to check. The automation will only unlock if this door is currently locked.
      selector:
        entity:
          domain: lock
    door_lock_rule_select:
      name: Door Lock Rule Select Entity
      description: The select entity that controls the door lock mode.
      selector:
        entity:
          domain: select
    notify_device:
      name: Notification Device
      description: Select the mobile device to send notifications to.
      selector:
        device:
          integration: mobile_app

variables:
  unlock_offset_val: !input unlock_offset
  input_text_keyword_entity: !input input_text_keyword

trigger:
  - platform: calendar
    event: start
    entity_id: !input calendar_entity
    offset: !input unlock_offset

condition:
  - condition: state
    entity_id: !input door_lock_entity
    state: "locked"
  - condition: template
    value_template: >
      {% set summary = trigger.calendar_event.summary | lower %}
      {% set keyword = states(input_text_keyword_entity) | lower %}
      {{ keyword | length > 0 and keyword in summary and 'canceled' not in summary }}

action:
  - service: select.select_option
    target:
      entity_id: !input door_lock_rule_select
    data:
      option: "keep_unlock"
  - domain: mobile_app
    type: notify
    device_id: !input notify_device
    title: "Door Unlocked"
    message: >
      {% set event_title = trigger.calendar_event.summary if trigger.calendar_event is defined else 'Unknown Event' %}
      {% set start_time = as_timestamp(trigger.calendar_event.start) | timestamp_custom('%I:%M %p') if trigger.calendar_event is defined else 'Unknown Time' %}
      {% set offset_minutes = unlock_offset_val.minutes | default(0) %}
      {% set offset_hours = unlock_offset_val.hours | default(0) %}
      {% set offset_str = '' %}
      {% if offset_hours > 0 %}
        {% set offset_str = offset_str ~ offset_hours ~ ' hours ' %}
      {% endif %}
      {% if offset_minutes > 0 %}
        {% set offset_str = offset_str ~ offset_minutes ~ ' minutes ' %}
      {% endif %}
      Event "{{ event_title }}" starting at {{ start_time }}. Door unlocked {{ offset_str }}early.

mode: single
