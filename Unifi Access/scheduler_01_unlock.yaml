blueprint:
  name: "Scheduler: Unlock Door"
  description: >
    Unlocks the door BEFORE an event starts.
    
    IMPORTANT:
    The "Unlock Offset" must be a TEXT string starting with a negative sign.
    Example: "-00:30:00" (30 minutes before).
  domain: automation
  input:
    calendar_entity:
      name: Calendar Entity
      description: Select the calendar to monitor for events.
      selector:
        entity:
          domain: calendar
    input_text_keyword:
      name: Door Keyword Input Text
      description: >
        Select the input_text entity that stores the door keyword (e.g., *).
        If this is empty, the door will NOT unlock (Security feature).
      selector:
        entity:
          domain: input_text
    unlock_offset:
      name: "Unlock Offset (Format: -HH:MM:SS)"
      description: >
        Time BEFORE start to unlock. MUST start with a minus sign (-).
        Example: "-00:30:00" for 30 minutes.
      default: "-00:30:00"
      selector:
        text: {}
    door_lock_entity:
      name: Door Lock Entity
      description: The door lock to check. The automation will only unlock if this door is currently locked.
      selector:
        entity:
          domain: lock
    door_lock_rule_select:
      name: Door Lock Rule Select Entity
      description: The select entity that controls the door lock mode (sets to 'keep_unlock').
      selector:
        entity:
          domain: select
    notify_device:
      name: Notification Device
      description: Select the mobile device to send notifications to.
      selector:
        device:
          integration: mobile_app

# ----------------------------------------------------------------------
# VARIABLES
# ----------------------------------------------------------------------
variables:
  unlock_offset_val: !input unlock_offset
  input_text_keyword_entity: !input input_text_keyword

trigger:
  - platform: calendar
    event: start
    entity_id: !input calendar_entity
    offset: !input unlock_offset

condition:
  # 1. Only run if the door is actually locked
  - condition: state
    entity_id: !input door_lock_entity
    state: "locked"

  # 2. Main Logic: Check Keyword, Trim Spaces, and Check for Cancellation
  - condition: template
    value_template: >
      {# Get data and normalize to lowercase #}
      {% set summary = trigger.calendar_event.summary | lower | default('') %}
      
      {# Get Keyword and TRIM invisible spaces #}
      {% set keyword = states(input_text_keyword_entity) | trim | lower %}
      
      {# LOGIC: #}
      {# 1. Keyword must not be empty (safety) #}
      {# 2. Keyword must be inside the Event Title #}
      {# 3. 'canceled' must NOT be in the title #}
      
      {{ keyword | length > 0 and keyword in summary and 'canceled' not in summary and 'cancelled' not in summary }}

action:
  - service: select.select_option
    target:
      entity_id: !input door_lock_rule_select
    data:
      option: "keep_unlock"
      
  - domain: mobile_app
    type: notify
    device_id: !input notify_device
    title: "Door Unlocked"
    message: >
      Event "{{ trigger.calendar_event.summary }}" is starting soon. 
      Door unlocked automatically.

# Parallel mode ensures overlapping start times don't block each other
mode: parallel
max: 10
